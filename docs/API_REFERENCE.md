# Kyrios Bot - API リファレンス

## コマンド一覧

Kyriosボットで利用可能なすべてのコマンドとその使用方法を説明します。

## 基本コマンド

### Ping コマンド

#### `/ping`
**説明**: ボットのレスポンス時間を測定します

**使用方法**:
```
/ping
```

**出力例**:
```
🏓 Pong! レイテンシ: 45ms
```

**権限**: なし（全ユーザー使用可能）

---

## ユーティリティコマンド

### アバター・バナー表示

#### `/avatar [user]`
**説明**: ユーザーのアバターとバナーを高機能表示・ダウンロード

**パラメーター**:
- `user` (オプション): 対象ユーザー（省略時は実行者）

**使用方法**:
```
/avatar
/avatar @username
/avatar 123456789012345678
```

**機能**:

##### 🖼️ アバター表示
- **複数サイズ対応**: 128px, 256px, 512px, 1024px
- **サーバー専用アバター検出**: グローバルアバターとの差異表示
- **画像詳細情報**:
  - ファイル形式（PNG, JPG, GIF, WebP）
  - ファイルサイズ
  - 解像度
  - アニメーション有無
  - 主要色抽出（16進カラーコード）

##### 🎨 バナー表示
- **高解像度表示**: 1024px品質
- **ダウンロードリンク**: 直接ダウンロード可能
- **詳細情報**: 形式・サイズ・主要色

##### 💾 ダウンロード機能
- **マルチサイズダウンロード**: 4つのサイズ別ボタン
- **ワンクリックアクセス**: 直接リンク提供
- **バナーダウンロード**: 存在する場合のみ表示

##### 📊 統計・履歴機能
- **アバター変更統計**:
  - 総変更回数
  - バナー変更回数
  - 初回確認日時
  - 最新変更日時
  - よく使用する画像形式

- **変更履歴**:
  - 最新5件の変更ログ
  - 変更タイプ別分類（アバター/バナー/サーバーアバター）
  - 各変更の主要色・形式記録

##### 🔍 画像解析
- **色彩分析**: 支配的色彩の自動抽出
- **メタデータ取得**: ファイル形式・サイズ等
- **品質評価**: 解像度・圧縮情報

**出力例**:
```
🖼️ UserName のアバター・バナー情報

👤 ユーザー情報
名前: UserName
ID: 123456789012345678
アカウント作成: 2年前

🖼️ アバター詳細
URL: [表示](https://cdn.discordapp.com/...)
形式: PNG
ファイルサイズ: 45,231 bytes
解像度: 1024×1024px
アニメーション: なし
主要色: #3b82f6
```

**インタラクティブUI**:
- `Avatar 128px` `Avatar 256px` `Avatar 512px` `Avatar 1024px` ボタン
- `Banner` ボタン（存在時のみ）
- `📊 統計情報` ボタン
- `📜 履歴` ボタン

**権限**: なし（全ユーザー使用可能）
**クールダウン**: なし
**エフェメラル**: ダウンロード・統計・履歴は個人表示

---

## チケットシステム

### チケットパネル設置

#### `/ticket`
**説明**: チケット作成用のパネルを設置します

**使用方法**:
```
/ticket
```

**権限**: `manage_guild` (サーバー管理権限)

**機能**:
- チケット作成ボタンの設置
- カテゴリ別チケット分類
- 優先度設定機能

### チケット管理UI

#### チケット作成ボタン
**説明**: ユーザーが新しいサポートチケットを作成

**動作**:
1. 専用チャンネルの作成
2. 権限設定（作成者＋管理者のみアクセス）
3. 管理用UIの表示

**制限**:
- 1ユーザーあたり最大3つまで（設定変更可能）
- 適切な権限が必要

#### チケット管理ボタン

##### 🏷️ カテゴリ変更
**説明**: チケットのカテゴリを変更

**利用可能カテゴリ**:
- `technical` - 技術的な問題
- `moderation` - モデレーション関連
- `general` - 一般的な質問
- `other` - その他

##### 👤 アサイン
**説明**: 担当者をチケットに割り当て

**使用方法**:
- ユーザーID入力: `123456789012345678`
- メンション入力: `@username`

##### ⚡ 優先度変更
**説明**: チケットの優先度を設定

**優先度レベル**:
- ⚪ **低** (1) - 一般的な質問
- 🟢 **中** (2) - 標準的な問題（デフォルト）
- 🟡 **高** (3) - 重要な問題
- 🔴 **緊急** (4) - 即座の対応が必要

##### 🔒 クローズ
**説明**: チケットを閉じる

**権限**:
- チケット作成者
- `manage_messages` 権限を持つユーザー

**動作**:
- チケットステータスをクローズに変更
- チャンネル名を `closed-` プレフィックス付きに変更
- アーカイブカテゴリに移動（設定されている場合）

---

## ログシステム

### ログ設定

#### `/logger`
**説明**: 現在のチャンネルをログ出力先に設定

**使用方法**:
```
/logger
```

**権限**: `manage_guild` (サーバー管理権限)

**ログ対象**:
- 📝 メッセージの削除・編集
- 📥📤 メンバーの参加・退出
- 🔨 モデレーション操作（Ban, Kick, Timeout等）
- 🏷️ ロール変更
- 📝🗂️ チャンネル作成・削除

### 自動ログ機能

#### メッセージ削除ログ
**トリガー**: メッセージが削除された時

**情報**:
- 削除されたメッセージ内容
- 作成者情報
- 削除時刻
- チャンネル情報

#### メッセージ編集ログ
**トリガー**: メッセージが編集された時

**情報**:
- 編集前後の内容
- 編集者情報
- 編集時刻
- チャンネル情報

#### メンバー参加ログ
**トリガー**: 新しいメンバーがサーバーに参加

**情報**:
- ユーザー情報
- 参加時刻
- アカウント作成日

#### メンバー退出ログ
**トリガー**: メンバーがサーバーから退出

**情報**:
- ユーザー情報
- 退出時刻
- 在籍期間

---

## イベントシステム

### カスタムイベント

Kyriosはイベントドリブンアーキテクチャを採用しており、以下のイベントが自動的に発火されます：

#### Bot関連イベント
- `bot_ready` - ボット起動完了
- `bot_shutdown` - ボット終了
- `guild_join` - サーバー参加
- `guild_remove` - サーバー退出

#### チケット関連イベント
- `ticket_created` - チケット作成
- `ticket_closed` - チケットクローズ
- `ticket_assigned` - 担当者アサイン

#### ログ関連イベント
- `logger_setup` - ログシステム設定
- `message_logged` - メッセージログ記録

---

## エラーハンドリング

### コマンドエラー

#### 権限不足
```
❌ あなたはこのコマンドを実行する権限がありません。
```

#### クールダウン
```
⏰ このコマンドは XX.XX 秒後に使用できます。
```

#### コマンドが見つからない
- ボットは反応しません（ログには記録）

#### 一般的なエラー
```
❌ コマンドの実行中にエラーが発生しました。
```

---

## 設定パラメーター

### config.toml 設定

#### [bot] セクション
```toml
[bot]
token = "YOUR_BOT_TOKEN"              # Discord Bot Token
prefix = "!"                          # コマンドプレフィックス
description = "Kyrios - Advanced Discord Administration Bot"
```

#### [features] セクション
```toml
[features]
tickets = true                        # チケット機能
logger = true                         # ログ機能
auto_mod = false                     # 自動モデレーション（未実装）
```

#### [tickets] セクション
```toml
[tickets]
category_id = 123456789012345678      # チケットカテゴリID（オプション）
archive_category_id = 876543210987654321  # アーカイブカテゴリID（オプション）
max_per_user = 3                      # 1ユーザーあたりの最大チケット数
```

#### [logger] セクション
```toml
[logger]
ignore_bots = true                    # ボットのアクションを無視
log_edits = true                      # メッセージ編集をログ
log_deletes = true                    # メッセージ削除をログ
log_joins = true                      # メンバー参加をログ
```

---

## 使用例

### 基本的なセットアップ

1. **ログシステム設定**:
   ```
   /logger
   ```

2. **チケットシステム設置**:
   ```
   /ticket
   ```

### チケット管理フロー

1. ユーザーがチケット作成ボタンをクリック
2. 専用チャンネルが自動作成
3. 管理者がカテゴリ・優先度・担当者を設定
4. 問題解決後、チケットをクローズ

### ログ分析

- メッセージ削除・編集の監視
- メンバーの参加・退出パターン分析
- モデレーション操作の履歴確認

---

## 開発者向けAPI

### イベントバス使用例

```python
# カスタムイベントの発火
await self.bot.event_bus.emit_event("custom_event", {
    "user_id": user.id,
    "action": "custom_action",
    "timestamp": datetime.utcnow()
})
```

### データベース操作例

```python
# チケット作成
ticket = await self.bot.database.create_ticket(
    guild_id=guild.id,
    user_id=user.id,
    title="サポートリクエスト"
)

# ログエントリ作成
await self.bot.database.create_log_entry(
    guild_id=guild.id,
    log_type=LogType.MESSAGE_DELETE,
    content="メッセージが削除されました"
)
```

---

## 制限事項

### レート制限
- Discord API制限に準拠
- 連続コマンド実行には制限なし（現在）

### 権限要求
- チケット・ログ機能: サーバー管理権限
- 基本コマンド: 権限不要

### データ保存
- SQLiteデータベース使用
- 自動バックアップ機能
- データ暗号化なし（設定ファイルは要保護）

## サポート

APIの使用方法や追加機能の要望は：
- GitHub Issues
- [CONTRIBUTING.md](CONTRIBUTING.md)
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md)